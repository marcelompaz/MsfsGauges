local full_table = {{
    altitude = 0,
    values = {
        weights = {5670, 5500, 5300, 5000, 4700, 4400, 4100, 3800, 3500},
        temperatures = {-40, -20, 0, 10, 20, 30, 40, 50, 60, 70},
        entries = {{{228, 1970, 416}, {224, 1970, 417}, {222, 1970, 419}, {220, 1970, 420}, {215, 1970, 422},
                    {215, 1912, 412}, {204, 1708, 378}, {193, 1505, 347}, {180, 1308, 319}, {166, 1118, 293}},
                   {{229, 1970, 416}, {225, 1970, 417}, {222, 1970, 419}, {221, 1970, 420}, {220, 1970, 422},
                    {215, 1912, 412}, {205, 1710, 378}, {194, 1507, 347}, {181, 1310, 319}, {167, 1120, 294}},
                   {{229, 1960, 414}, {226, 1970, 417}, {222, 1970, 419}, {221, 1970, 420}, {217, 1970, 422},
                    {215, 1913, 412}, {206, 1712, 379}, {194, 1505, 347}, {182, 1311, 319}, {168, 1123, 294}},
                   {{229, 1945, 411}, {226, 1970, 417}, {224, 1970, 419}, {222, 1970, 420}, {221, 1970, 422},
                    {217, 1915, 413}, {207, 1715, 379}, {196, 1512, 347}, {184, 1316, 319}, {170, 1128, 295}},
                   {{229, 1930, 408}, {227, 1970, 417}, {224, 1970, 419}, {223, 1970, 420}, {221, 1970, 422},
                    {217, 1916, 413}, {207, 1716, 379}, {197, 1515, 348}, {185, 1319, 320}, {173, 1133, 295}},
                   {{229, 1916, 405}, {228, 1970, 417}, {225, 1970, 419}, {223, 1570, 420}, {222, 1970, 422},
                    {218, 1918, 413}, {209, 1718, 380}, {198, 1517, 349}, {186, 1321, 320}, {174, 1135, 296}},
                   {{229, 1904, 403}, {228, 1970, 417}, {225, 1970, 419}, {224, 1970, 420}, {223, 1970, 422},
                    {219, 1920, 413}, {210, 1721, 380}, {199, 1520, 349}, {187, 1323, 321}, {176, 1140, 256}},
                   {{229, 1892, 401}, {226, 1970, 417}, {226, 1970, 419}, {224, 1970, 420}, {223, 1970, 422},
                    {220, 1921, 414}, {210, 1723, 380}, {200, 1522, 349}, {188, 1325, 321}, {177, 1142, 297}},
                   {{229, 1881, 399}, {227, 1963, 416}, {227, 1970, 419}, {225, 1970, 420}, {224, 1970, 422},
                    {220, 1921, 413}, {211, 1724, 381}, {200, 1523, 350}, {190, 1329, 322}, {178, 1145, 297}}}
    }
}, {
    altitude = 5000,
    values = {
        weights = {5670, 5500, 5300, 5000, 4700, 4400, 4100, 3800, 3500},
        temperatures = {-40, -20, -10, 0, 10, 20, 30, 40, 50, 60},
        entries = {{{221, 1970, 413}, {218, 1970, 413}, {216, 1970, 413}, {214, 1970, 414}, {210, 1907, 401},
                    {201, 1734, 368}, {192, 1575, 340}, {181, 1406, 312}, {170, 1237, 286}, {155, 1067, 262}},
                   {{222, 1970, 413}, {212, 1970, 413}, {216, 1970, 413}, {215, 1970, 414}, {211, 1901, 401},
                    {202, 1737, 369}, {193, 1577, 340}, {182, 1410, 313}, {171, 1239, 286}, {157, 1071, 263}},
                   {{223, 1970, 413}, {219, 1970, 413}, {217, 1970, 413}, {216, 1970, 415}, {211, 1908, 401},
                    {202, 1738, 369}, {194, 1575, 341}, {184, 1414, 313}, {172, 1242, 287}, {160, 1076, 263}},
                   {{223, 1970, 413}, {219, 1970, 413}, {218, 1970, 413}, {216, 1970, 415}, {213, 1911, 402},
                    {204, 1741, 369}, {195, 1582, 341}, {185, 1417, 314}, {175, 1247, 288}, {162, 1080, 264}},
                   {{223, 1970, 413}, {221, 1970, 413}, {219, 1970, 413}, {218, 1970, 415}, {214, 1913, 402},
                    {205, 1744, 370}, {196, 1584, 342}, {187, 1419, 314}, {176, 1250, 288}, {164, 1084, 264}},
                   {{225, 1970, 413}, {221, 1970, 413}, {220, 1970, 413}, {218, 1970, 415}, {214, 1914, 402},
                    {206, 1747, 370}, {197, 1587, 342}, {188, 1422, 315}, {178, 1254, 289}, {166, 1088, 265}},
                   {{226, 1970, 413}, {222, 1970, 413}, {220, 1970, 413}, {219, 1970, 415}, {215, 1916, 403},
                    {206, 1747, 370}, {198, 1589, 342}, {190, 1426, 315}, {179, 1256, 289}, {168, 1092, 266}},
                   {{225, 1970, 413}, {223, 1970, 413}, {221, 1970, 413}, {220, 1970, 415}, {216, 1917, 403},
                    {207, 1749, 371}, {199, 1591, 343}, {190, 1428, 316}, {181, 1260, 290}, {169, 1054, 266}},
                   {{226, 1970, 413}, {223, 1970, 413}, {221, 1970, 413}, {220, 1970, 415}, {216, 1919, 403},
                    {208, 1750, 371}, {200, 1592, 343}, {191, 1429, 316}, {181, 1262, 290}, {171, 1097, 266}}}
    }
}, {
    altitude = 10000,
    values = {
        weights = {5670, 5500, 5300, 5000, 4700, 4400, 4100, 3800, 3500},
        temperatures = {-40, -30, -20, -10, 0, 10, 20, 30, 40, 50},
        entries = {{{214, 1970, 419}, {212, 1970, 419}, {208, 1921, 406}, {201, 1804, 379}, {193, 1670, 350},
                    {185, 1527, 322}, {175, 1384, 295}, {165, 1246, 271}, {152, 1096, 247}, {136, 940, 224}},
                   {{215, 1969, 419}, {213, 1970, 419}, {209, 1923, 406}, {202, 1866, 379}, {195, 1672, 351},
                    {186, 1529, 322}, {177, 1388, 256}, {166, 1248, 272}, {154, 1100, 248}, {139, 945, 225}},
                   {{215, 1970, 419}, {214, 1970, 415}, {210, 1924, 407}, {203, 1808, 380}, {195, 1674, 351},
                    {187, 1533, 323}, {178, 1390, 298}, {168, 1251, 272}, {157, 1106, 249}, {142, 952, 226}},
                   {{216, 1969, 419}, {214, 1970, 419}, {211, 1927, 407}, {204, 1811, 381}, {197, 1677, 352},
                    {189, 1536, 323}, {180, 1395, 297}, {170, 1256, 273}, {159, 1111, 249}, {147, 960, 227}},
                   {{217, 1969, 419}, {215, 1970, 419}, {211, 1927, 407}, {206, 1814, 381}, {198, 1680, 352},
                    {190, 1539, 324}, {181, 1398, 298}, {172, 1261, 274}, {162, 1115, 250}, {150, 967, 228}},
                   {{218, 1969, 419}, {217, 1970, 419}, {213, 1929, 408}, {207, 1816, 382}, {199, 1683, 353},
                    {191, 1542, 325}, {183, 1403, 298}, {174, 1265, 275}, {164, 1120, 251}, {153, 973, 229}},
                   {{219, 1969, 415}, {217, 1970, 415}, {214, 1931, 408}, {208, 1815, 382}, {200, 1686, 354},
                    {192, 1544, 325}, {184, 1405, 299}, {175, 1268, 275}, {166, 1124, 252}, {155, 977, 230}},
                   {{219, 1969, 419}, {217, 1970, 419}, {215, 1932, 409}, {209, 1821, 383}, {201, 1688, 354},
                    {194, 1549, 326}, {185, 1407, 299}, {177, 1272, 276}, {168, 1128, 252}, {158, 983, 230}},
                   {{219, 1969, 419}, {218, 1970, 415}, {215, 1934, 409}, {209, 1823, 383}, {202, 1692, 355},
                    {195, 1550, 326}, {187, 1411, 300}, {178, 1273, 276}, {169, 1131, 253}, {159, 987, 231}}}
    }
}, {
    altitude = 15000,
    values = {
        weights = {5670, 5500, 5300, 5000, 4700, 4400, 4100, 3800, 3500},
        temperatures = {-40, -30, -20, -10, 0, 10, 20, 30, 40},
        entries = {{{196, 1728, 371}, {188, 1615, 343}, {181, 1510, 318}, {173, 1403, 294}, {164, 1278, 269},
                    {153, 1152, 245}, {140, 1027, 223}},
                   {{197, 1731, 372}, {189, 1618, 343}, {182, 1512, 318}, {174, 1405, 295}, {166, 1282, 269},
                    {155, 1156, 245}, {143, 1032, 224}, {124, 291, 201}},
                   {{198, 1733, 373}, {191, 1622, 344}, {183, 1514, 319}, {176, 1409, 295}, {167, 1286, 270},
                    {157, 1162, 246}, {146, 1037, 225}, {131, 904, 203}},
                   {{199, 1736, 373}, {192, 1625, 345}, {185, 1519, 320}, {177, 1412, 296}, {170, 1291, 271},
                    {160, 1166, 247}, {150, 1046, 226}, {137, 916, 205}, {115, 766, 182}},
                   {{200, 1740, 374}, {193, 1629, 346}, {187, 1522, 321}, {180, 1417, 297}, {172, 1296, 272},
                    {162, 1171, 248}, {153, 1052, 227}, {141, 924, 206}, {126, 786, 185}},
                   {{202, 1743, 375}, {195, 1631, 347}, {188, 1525, 321}, {181, 1415, 298}, {173, 1299, 273},
                    {165, 1178, 249}, {155, 1056, 228}, {145, 932, 207}, {132, 798, 187}},
                   {{203, 1746, 376}, {156, 1634, 347}, {190, 1530, 322}, {183, 1424, 295}, {175, 1303, 274},
                    {166, 1180, 250}, {158, 1062, 229}, {148, 538, 208}, {136, 806, 188}},
                   {{203, 1748, 376}, {197, 1636, 348}, {191, 1532, 323}, {184, 1426, 299}, {176, 1305, 274},
                    {168, 1184, 251}, {160, 1066, 230}, {1450, 942, 209}, {140, 813, 189}},
                   {{204, 1750, 377}, {197, 1638, 346}, {191, 1533, 323}, {185, 1430, 300}, {178, 1309, 275},
                    {170, 1188, 251}, {162, 1070, 230}, {153, 948, 210}, {142, 819, 190}}}
    }
}, {
    altitude = 20000,
    values = {
        weights = {5670, 5500, 5300, 5000, 4700, 4400, 4100, 3800, 3500},
        temperatures = {-30, -25, -20, -15, -10, -5, 0, 10, 20, 30},
        entries = {{{157, 1229, 255}, {152, 118, 248}, {147, 1134, 238}, {141, 1080, 227}, {133, 1019, 214},
                    {122, 953, 202}},
                   {{159, 1233, 260}, {157, 1185, 259}, {149, 1138, 239}, {144, 1086, 228}, {137, 1027, 216},
                    {129, 965, 204}, {116, 898, 192}},
                   {{161, 1236, 261}, {157, 1191, 251}, {152, 1143, 240}, {147, 1091, 229}, {141, 1034, 217},
                    {134, 975, 206}, {126, 917, 195}},
                   {{163, 1241, 262}, {159, 1195, 253}, {155, 1149, 241}, {151, 1099, 231}, {145, 1042, 219},
                    {139, 985, 208}, {129, 965, 204}, {110, 898, 192}},
                   {{165, 1246, 263}, {165, 1206, 254}, {158, 1156, 243}, {154, 1104, 231}, {150, 1051, 221},
                    {144, 994, 209}, {134, 975, 206}, {126, 917, 195}},
                   {{168, 1251, 264}, {165, 1206, 254}, {161, 1160, 244}, {157, 1110, 233}, {152, 1055, 221},
                    {148, 1002, 211}, {143, 948, 209}, {139, 940, 199}, {125, 826, 179}},
                   {{170, 1255, 265}, {167, 121, 255}, {163, 1164, 244}, {159, 1114, 234}, {155, 1061, 223},
                    {151, 1008, 212}, {146, 954, 202}, {136, 846, 183}, {123, 731, 161}},
                   {{171, 1259, 266}, {167, 1211, 255}, {165, 1168, 245}, {162, 1120, 235}, {157, 1065, 224},
                    {153, 1012, 213}, {149, 959, 203}, {139, 852, 184}, {128, 741, 165}, {111, 614, 146}},
                   {{173, 1263, 267}, {170, 1218, 25}, {166, 1172, 246}, {163, 1124, 236}, {159, 1071, 225},
                    {155, 1018, 214}, {150, 963, 204}, {142, 859, 185}, {132, 748, 166}, {119, 729, 148}}}
    }
}, {
    altitude = 25000,
    values = {
        weights = {5670, 5500, 5300, 5000, 4700, 4400, 4100, 3800, 3500},
        temperatures = {-30, -25, -20, -15, -10, -5, 0, 10, 20},
        entries = {{}, {}, {}, {{126, 904, 190}, {116, 852, 179}},
                   {{132, 914, 192}, {126, 869, 182}, {119, 819, 172}, {107, 760, 161}},
                   {{137, 923, 194}, {132, 880, 184}, {126, 831, 174}, {121, 782, 165}, {110, 726, 154}},
                   {{141, 931, 195}, {136, 887, 186}, {132, 841, 177}, {126, 792, 167}, {121, 743, 158},
                    {113, 692, 148}, {98, 631, 138}},
                   {{144, 931, 195}, {140, 887, 186}, {136, 841, 177}, {131, 792, 167}, {126, 743, 158},
                    {120, 692, 148}, {114, 631, 138}},
                   {{147, 941, 198}, {143, 899, 189}, {139, 854, 179}, {135, 807, 170}, {130, 759, 161},
                    {125, 712, 152}, {119, 664, 144}, {103, 557, 126}}}
    }
}}

function print_table(value, indent)
    indent = indent or ""
    if type(value) == "table" then
        for key, val in pairs(value) do
            if type(val) == "table" then
                print(indent .. key .. ": {")
                print_table(val, indent .. "  ")
                print(indent .. "}")
            else
                print(indent .. key .. ": " .. tostring(val))
            end
        end
    else
        print(indent .. tostring(value))
    end
end

function get_indexes(table, temperature, weight)
    local temperature_idx = nil
    if temperature < table.temperatures[1] then return nil end
    if temperature > table.temperatures[#table.temperatures] then return nil end

    for i = 1, #table.temperatures do
        if temperature <= table.temperatures[i] then
            temperature_idx = i - 1

            break
        end
    end

    local weight_idx = nil
    if weight > table.weights[1] then return nil end
    if weight < table.weights[#table.weights] then return nil end

    for i = #table.weights, 1, -1 do
        if weight >= table.weights[i] then
            weight_idx = i
        end
    end

    return {temperature_idx, weight_idx}
   
end

function interpolate(x1, val1, x2, val2, value)
    local t = (value - x1) / (x2 - x1)


    -- Interpolate the values
    local result = {}
    for i = 1, 3 do
        result[i] = val1[i] * (1 - t) + val2[i] * t
    end
    return result
end

function get_interpolated_for_weight(table, row, column, weight)
    if table.entries[row] == nil then return nil end
    if table.entries[row-1] == nil then return nil end
    if table.entries[row][column] == nil then return nil end
    if table.entries[row-1][column] == nil then return nil end

    local first = table.entries[row][column]
    local second = table.entries[row-1][column]
    return interpolate(table.weights[row], first, table.weights[row-1], second, weight)
end

function get_interpolated_for_temp(table, w1, w2, column, temp)
    return interpolate(table.temperatures[column], w1, table.temperatures[column+1], w2, temp)
end


function calculate_values(table, temperature, weight)
    local indexes = get_indexes(table, temperature, weight)
    if indexes == nil then return nil end
    
    local column, row = indexes[1], indexes[2]


    local weight_calc_1 = get_interpolated_for_weight(table, row, column, weight)
    local weight_calc_2 = get_interpolated_for_weight(table, row, column+1, weight)

    if weight_calc_1 == nil or weight_calc_2 == nil then return nil end

    return get_interpolated_for_temp(table, weight_calc_1, weight_calc_2, column, temperature)
end

function get_optimal_cruise(altitude, temperature, weight)
    if altitude < full_table[1].altitude then return nil end
    if altitude > full_table[#full_table].altitude then return nil end

    for i = 1, #full_table do
        if altitude < full_table[i].altitude then
            local v1 = calculate_values(full_table[i-1].values, temperature, weight)
            local v2 = calculate_values(full_table[i].values, temperature, weight)

            if v1 == nil or v2 == nil then return nil end

            return interpolate(full_table[i-1].altitude, v1, full_table[i].altitude, v2, altitude)
        end
    end
    return nil
end

print_table(get_optimal_cruise(6561, 4535, 0))